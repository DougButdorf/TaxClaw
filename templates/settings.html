{% extends "base.html" %}
{% block content %}
  <div class="row" style="justify-content: space-between; margin-bottom: 14px;">
    <h1 style="margin:0; font-size: 20px;">Settings</h1>
    <div class="muted" style="font-size: 13px;">Config: <code style="color: var(--text);">{{ config_path }}</code></div>
  </div>

  <div class="card" style="margin-bottom: 14px;">
    {% if status_level == 'full_local' %}
      <div style="font-size: 16px; font-weight: 700;">üü¢ FULLY LOCAL ‚Äî All processing on this machine. Nothing leaves.</div>
    {% else %}
      <div style="font-size: 16px; font-weight: 700;">üü° PARTIALLY LOCAL ‚Äî Data stored here, but sent to <b>{{ cloud_model }}</b> for extraction.</div>
      {% if needs_privacy_ack %}
        <div class="muted" style="margin-top: 8px;">Cloud mode is selected but not acknowledged. Upload/extraction will be blocked until you confirm below.</div>
      {% endif %}
    {% endif %}
  </div>

  {% if error %}
    <div class="card" style="border-color: rgba(239,68,68,0.35); margin-bottom: 14px;">
      <div style="color: var(--bad); font-weight: 700;">{{ error }}</div>
    </div>
  {% endif %}

  <div class="card">
    <form method="post" action="/settings" id="settings-form">
      <div style="display:grid; grid-template-columns: 1fr; gap: 14px;">

        <div>
          <div style="font-weight:700; margin-bottom: 8px;">Model backend</div>
          <label style="display:flex; gap:10px; align-items:center; margin-bottom: 6px;">
            <input type="radio" name="model_backend" value="local" {% if cfg.model_backend == 'local' %}checked{% endif %} />
            <span>Local (Ollama) ‚Äî recommended</span>
          </label>
          <label style="display:flex; gap:10px; align-items:center;">
            <input type="radio" name="model_backend" value="cloud" {% if cfg.model_backend == 'cloud' %}checked{% endif %} />
            <span>Cloud ‚Äî sends tax document content to an external AI provider</span>
          </label>
        </div>

        <div id="local-section" style="padding-top: 6px;">
          <div style="font-weight:700; margin-bottom: 8px;">Local model (Ollama)</div>
          <select name="local_model" style="min-width: 320px;">
            {% for m in local_models %}
              <option value="{{ m }}" {% if cfg.local_model == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
            {% if local_models|length == 0 %}
              <option value="{{ cfg.local_model }}" selected>{{ cfg.local_model }}</option>
            {% endif %}
          </select>
          <div class="muted" style="margin-top: 8px; font-size: 13px;">Installed models are fetched from <code style="color: var(--text);">http://localhost:11434/api/tags</code>.</div>
        </div>

        <div id="cloud-section" style="padding-top: 6px;">
          <div style="font-weight:700; margin-bottom: 8px;">Cloud model</div>
          <select name="cloud_model" id="cloud-model" style="min-width: 320px;">
            {% for cm in cloud_models %}
              <option value="{{ cm }}" {% if cfg.cloud_model == cm %}selected{% endif %}>{{ cm }}</option>
            {% endfor %}
          </select>

          <div style="height: 10px;"></div>
          <label style="display:flex; gap:10px; align-items:flex-start;">
            <input type="checkbox" id="privacy-ack" name="privacy_acknowledged" value="1" {% if cfg.privacy_acknowledged %}checked{% endif %} />
            <span>
              <div style="font-weight:700;">I understand and accept the privacy risk</div>
              <div class="muted" style="font-size: 13px; margin-top: 4px;">
                ‚ö†Ô∏è Your tax documents will be sent to an external AI provider. This includes document content, which may contain SSNs, income, and account numbers.
              </div>
            </span>
          </label>
        </div>

        <details style="
          border: 1px solid rgba(148,163,184,0.22);
          background: rgba(15,23,42,0.35);
          border-radius: 14px;
          padding: 12px 12px;
        ">
          <summary style="cursor:pointer; font-weight: 700; list-style: none;">
            üìä How model choice affects extraction quality
          </summary>
          <div style="height: 10px;"></div>

          <div style="display:grid; grid-template-columns: 1fr; gap: 12px; font-size: 13px;">
            <div>
              <div style="font-weight:700; margin-bottom: 6px;">Local (Ollama)</div>
              <div class="muted">‚úÖ Free ¬∑ ‚úÖ Fully private ¬∑ your data never leaves this machine</div>
              <div style="height: 8px;"></div>
              <div class="muted" style="margin-bottom: 6px;">‚ö†Ô∏è Smaller models may struggle with:</div>
              <ul class="muted" style="margin: 0 0 0 18px;">
                <li>Complex multi-copy forms (consolidated 1099s, K-1s)</li>
                <li>Low-quality scans or non-standard layouts</li>
                <li>Handwritten or corrected fields</li>
              </ul>
              <div class="muted" style="margin-top: 8px;">Typical confidence: <code style="color: var(--text);">0.60‚Äì0.85</code> on clean PDFs</div>
            </div>

            <div>
              <div style="font-weight:700; margin-bottom: 6px;">Cloud (Claude / OpenAI)</div>
              <ul class="muted" style="margin: 0 0 0 18px;">
                <li>‚úÖ Higher accuracy on complex forms</li>
                <li>‚úÖ Better handling of edge cases and poor scans</li>
                <li>‚úÖ Confidence typically <code style="color: var(--text);">0.85‚Äì0.97</code></li>
              </ul>
              <div style="height: 8px;"></div>
              <div class="muted">‚ö†Ô∏è Your document content leaves this machine ‚Äî see <a href="/privacy">Privacy Policy</a></div>
              <div class="muted">‚ö†Ô∏è Requires API key or cloud subscription</div>
            </div>

            <div class="muted">
              üí° Tip: Use local for standard W-2s and simple 1099s. Switch to cloud for consolidated brokerage statements, K-1s, and anything that comes back with low confidence.
            </div>
          </div>
        </details>

        <div class="row" style="justify-content: space-between;">
          <button type="submit">Save</button>
          <a class="muted" href="/">Back to documents</a>
        </div>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const form = document.getElementById('settings-form');
      const cloudModel = document.getElementById('cloud-model');
      const ack = document.getElementById('privacy-ack');
      if (!form || !cloudModel || !ack) return;

      function cloudConfirmIfNeeded() {
        const cloudSelected = form.querySelector('input[name="model_backend"][value="cloud"]').checked;
        if (!cloudSelected) return true;
        if (ack.checked) return true;

        const ok = window.confirm('‚ö†Ô∏è Your tax documents will be sent to an external AI provider. This includes document content, which may contain SSNs, income, and account numbers. Are you sure?');
        if (ok) {
          ack.checked = true;
          return true;
        }
        // revert to local
        form.querySelector('input[name="model_backend"][value="local"]').checked = true;
        return false;
      }

      // when user selects cloud backend, force confirm
      form.querySelectorAll('input[name="model_backend"]').forEach((el) => {
        el.addEventListener('change', () => {
          if (el.value === 'cloud') cloudConfirmIfNeeded();
        });
      });

      // if they change cloud model while not acknowledged, confirm
      cloudModel.addEventListener('change', () => {
        cloudConfirmIfNeeded();
      });

      form.addEventListener('submit', (e) => {
        if (!cloudConfirmIfNeeded()) {
          e.preventDefault();
        }
      });
    })();
  </script>
{% endblock %}
