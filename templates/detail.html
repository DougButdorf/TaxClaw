{% extends "base.html" %}
{% block content %}
  <div class="row" style="justify-content: space-between; margin-bottom: 14px;">
    <div>
      {% if doc.display_name %}
        <h1 style="margin:0; font-size: 20px;">{{ doc.display_name }}</h1>
        <div class="muted" style="font-size: 12px; margin-top: 2px;">{{ doc.id }}</div>
      {% else %}
        <h1 style="margin:0; font-size: 20px;">Document {{ doc.id[:8] }}</h1>
        <div class="muted" style="font-size: 12px; margin-top: 2px;">{{ doc.id }}</div>
      {% endif %}
      <div class="muted">{{ doc.original_filename }} ‚Ä¢ {{ doc.doc_type }} ‚Ä¢ {{ doc.page_count }} pages</div>
    </div>
    <div class="row" style="flex-direction: column; align-items: flex-end; gap: 8px;">
      <div style="background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.35); border-radius: 10px; padding: 8px 14px; font-size: 12px; color: var(--warn); max-width: 460px; text-align: right;">
        ‚ö†Ô∏è Verify all extracted values against your original document before using for tax filing.
        TaxClaw uses AI extraction ‚Äî values may contain errors.
      </div>
      <div class="row">
      <a href="/doc/{{ doc.id }}/download" class="muted">Download original</a>
      <a href="/doc/{{ doc.id }}/export.wide.csv" class="btn export-link" data-export="wide">Export wide CSV</a>
      <a href="/doc/{{ doc.id }}/export.long.csv" class="btn export-link" data-export="long">Export long CSV</a>
      <a href="/doc/{{ doc.id }}/export.json" class="btn export-link" data-export="json">Export JSON</a>
      <form method="post" action="/doc/{{ doc.id }}/delete" onsubmit="return confirm('Delete this document? This removes it from the DB and deletes the stored file.');">
        <button class="danger" type="submit">Delete</button>
      </form>
      </div><!-- /inner row -->
    </div>
  </div>

  <div class="card" style="margin-bottom: 14px;">
    <div class="row" style="gap: 18px; align-items: flex-start;">
      <div style="flex: 1;">
        <div class="muted" style="margin-bottom: 6px;">Preview</div>
        <img src="/doc/{{ doc.id }}/preview.png" style="max-width: 100%; border-radius: 8px; border: 1px solid #222;" />
      </div>
      <div style="width: 360px;">
        <div class="muted" style="margin-bottom: 6px;">Metadata</div>
        <form method="post" action="/doc/{{ doc.id }}/update">
          <label class="muted">Name</label>
          <input name="display_name" value="{{ doc.display_name or '' }}" placeholder="e.g. Brex Treasury LLC ‚Äî 1099-DIV ‚Äî 2023" />
          <label class="muted">Doc type</label>
          <input name="doc_type" value="{{ doc.doc_type or '' }}" />
          <label class="muted">Tax year</label>
          <input name="year" value="{{ doc.tax_year or '' }}" />
          <label class="muted">Filer</label>
          <input name="filer" value="{{ doc.filer or '' }}" />
          <label class="muted">Notes</label>
          <textarea name="notes" rows="4">{{ doc.notes or '' }}</textarea>
          <div style="height: 8px;"></div>
          <button type="submit">Save</button>
        </form>
        <div style="height: 12px;"></div>
        <div class="row" style="gap: 18px;">
          <div><div class="muted">Status</div><div>{{ doc.status }}</div></div>
          <div><div class="muted">Needs review</div><div>{{ doc.needs_review }}</div></div>
        </div>
        <div style="height: 8px;"></div>
        <div class="row" style="gap: 18px;">
          <div><div class="muted">Classify conf</div><div>{{ '%.2f'|format(doc.classification_confidence or 0) }}</div></div>
          <div><div class="muted">Overall conf</div><div>{{ '%.2f'|format(doc.overall_confidence or 0) }}</div></div>
        </div>
      </div>
    </div>
  </div>

  {% if doc.doc_type == '1099-DA' and transactions %}
    <div class="card" style="margin-bottom: 14px;">
      <h2 style="margin:0 0 10px 0; font-size: 16px;">1099-DA Transactions ({{ transactions|length }})</h2>
      <table>
        <thead>
          <tr>
            <th>Asset</th>
            <th>Units</th>
            <th>Date acquired</th>
            <th>Date sold</th>
            <th>Proceeds</th>
            <th>Cost basis</th>
            <th>Term</th>
            <th>8949</th>
            <th>Noncovered</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
            <tr>
              <td>{{ t.asset_name or '' }} <span class="muted">{{ t.asset_code or '' }}</span></td>
              <td>{{ t.units or '' }}</td>
              <td>{{ t.date_acquired or '' }}</td>
              <td>{{ t.date_sold or '' }}</td>
              <td>{{ t.proceeds or '' }}</td>
              <td>
                {% if t.cost_basis %}
                  {{ t.cost_basis }}
                {% else %}
                  <span class="pill warn">missing</span>
                {% endif %}
              </td>
              <td>{{ t.gain_loss_term or '' }}</td>
              <td>{{ t.form_8949_code or '' }}</td>
              <td>{{ t.noncovered or '' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

  <div class="card" style="margin-bottom: 14px;">
    <h2 style="margin:0 0 10px 0; font-size: 16px;">Extracted fields</h2>
    {% if fields and fields|length > 0 %}
      <table>
        <thead><tr><th>Field</th><th>Value</th></tr></thead>
        <tbody>
          {% for k,v in fields %}
            <tr>
              <td class="muted">{{ k }}</td>
              <td>{{ v or '' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted">No extracted fields stored.</div>
    {% endif %}
  </div>

  {% if doc.doc_type in ['1099-DA', '1099-B', 'consolidated-1099'] %}
    <div class="card" style="margin-bottom: 14px; border-color: rgba(96,165,250,0.35); background: rgba(17,24,39,0.92);">
      <div style="font-size: 16px; font-weight: 900; margin-bottom: 6px;">ü™ô Got a {{ doc.doc_type }}? Your next step is cost basis reconciliation.</div>
      <div class="muted" style="line-height: 1.6;">
        TaxClaw extracted your proceeds ‚Äî but cost basis often isn't on the form. To complete your crypto tax picture, you'll need a reconciliation tool:
      </div>
      <div class="row" style="margin-top: 12px; gap: 10px;">
        <a class="btn" href="https://koinly.io/?via=4C2DBEFF&utm_source=affiliate" target="_blank" rel="noopener">‚Üí Try Koinly</a>
        <a class="btn" href="https://zenledger.io/" target="_blank" rel="noopener">‚Üí Try ZenLedger</a>
      </div>
      <div class="muted" style="margin-top: 10px; font-size: 12px;">
        ‚ö†Ô∏è Affiliate disclosure: TaxClaw earns a commission if you purchase Koinly via the link above. ZenLedger is a plain referral. These are tools we recommend ‚Äî they don't affect your extracted data.
      </div>
    </div>
  {% endif %}

  <div id="post-export-msg" class="muted" style="display:none; margin: 6px 0 14px 0; font-size: 13px;">
    ‚úÖ Export ready. If you need to reconcile cost basis, consider:
    <a href="https://koinly.io/?via=4C2DBEFF&utm_source=affiliate" target="_blank" rel="noopener">Koinly</a> ¬∑
    <a href="https://zenledger.io/" target="_blank" rel="noopener">ZenLedger</a>
  </div>

  <script>
    (function () {
      const isCrypto = {{ 'true' if doc.doc_type in ['1099-DA', '1099-B', 'consolidated-1099'] else 'false' }};
      if (!isCrypto) return;

      const msg = document.getElementById('post-export-msg');
      const links = document.querySelectorAll('a.export-link');
      if (!msg || !links || links.length === 0) return;

      function downloadInIframe(url) {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);
        // cleanup best-effort
        setTimeout(() => { try { iframe.remove(); } catch(e) {} }, 60000);
      }

      links.forEach((a) => {
        a.addEventListener('click', (ev) => {
          const kind = a.getAttribute('data-export');
          if (kind !== 'wide' && kind !== 'long') return; // only nudge after CSV exports
          ev.preventDefault();
          downloadInIframe(a.href);
          msg.style.display = 'block';
        });
      });
    })();
  </script>

  <div class="card">
    <h2 style="margin:0 0 10px 0; font-size: 16px;">Raw extraction JSON</h2>
    {% if extraction_pretty %}
      <pre>{{ extraction_pretty }}</pre>
    {% else %}
      <div class="muted">No extraction stored.</div>
    {% endif %}
  </div>
{% endblock %}
